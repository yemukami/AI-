## **エンジニア向け補足仕様書（v3.2.0対応版）**

### **1. NGトピック制御【柔軟化対応】**

-   **目的**：児童が「この話はしないで」と言った話題を、柔軟性を持って制御する。

-   **仕様**：

    -   `${ng_topics}` を配列（リスト）で保持。各項目に**軽度/強度フラグ**と**期限情報**を付与。

    -   会話中にユーザーが拒否発言した場合、エンジン側で以下を判定：
        - **軽度拒否**（「いまは話したくない」「ちょっと苦手」）→ 軽度NGとして追加、3-5セッション後に再確認フラグ設定
        - **強度拒否**（「絶対やめて」「すごく嫌い」「こわい」）→ 強度NGとして追加、児童の自発的再導入まで永続保持

    -   会話生成時、AIは ng_topics を参照し、軽度NGは慎重回避、強度NGは完全除外。

    -   **上位カテゴリ化は控えめに**（「サッカー嫌い」→「球技全般NG」ではなく「サッカー周辺のみ」）

### **2. 短文応答への対応【精緻化対応】**

-   **目的**：「うん」「わかんない」など短い返答への精緻な対応。

-   **仕様**：

    -   応答解析で「短文（2〜3語以下）」を判定するが、**感情トーン解析**を併用。

    -   **肯定的短答**（「うん♪」「いいね」明るいトーン）vs **回避的短答**（「うん...」「わからない」消極的トーン）を区別。

    -   **連続3-4回の回避的短答**で初めて切り替えを実行。肯定的短答は継続許可。

    -   対応パターン：共感＋ミクロ選択肢（A/B）／感情反映＋選択肢／体験談ブリッジ／感覚チャンネル切替

### **3. 無反応時の段階的再話しかけ【新規】**

-   **目的**：児童特性に応じた柔軟な再話しかけ。

-   **仕様**：

    -   **児童特性による動的タイムアウト調整**：
        - `${child_type}` = 「内向的」：60-90秒
        - `${child_type}` = 「活発」：30-45秒  
        - `${child_type}` = 「標準」：`${no_response_timeout_seconds}` 設定値通り

    -   **段階的アプローチ**：
        1. 第1回：低圧の呼びかけ（「少し静かだね。休憩でも大丈夫だよ」）
        2. 第2回：中圧の体験談付き（「こちらから少し話すね」＋軽い体験談）
        3. 最終回：終了案内（「今日はここまでにしようか。また話そうね」）

    -   最大 `${proactive_max_reprompts}` 回まで。`${proactive_enabled}` = false で機能停止。

### **4. 読み間違い（音読み/訓読み）【改善版】**

-   **目的**：TTS（音声合成）で自然な読み上げを実現。

-   **仕様**：

    -   **speech_text（音声用）**：
        - 日常語の漢字は使用可：「学校」「先生」「友達」「昨日」「今日」等
        - 音読み訓読み混同リスク語のみひらがな化：「忘れっぽい」→「わすれっぽい」
        - **音声プロソディ配慮**：抑揚・間を適度に入れ、落ち着いたテンポを指示

    -   **display_text（表示用）**：学年相応の漢字で可読性向上、意味内容は speech_text と完全一致

    -   **絵文字・記号処理**：絵文字・顔文字・記号アイコンは読み上げ処理から完全除外

### **5. 初回自己紹介フロー【継承】**

-   **目的**：初回利用時、自然な導入を行う。

-   **仕様**：

    -   `${first_session}` = true フラグを判定。

    -   true の場合のみ、AIが最初に自己紹介を実施。

    -   例：「こんにちは！僕は森のせんせい。これから一緒にお話していくよ。${handle_name}くんの好きなもの、少しずつ教えてね。」

    -   2回目以降は通常プロンプト通りに開始。

### **6. 安心フレーズのバリエーション制御【継承・拡張】**

-   **目的**：「今日はマイペースで〜」などの固定表現の繰り返しを防ぐ。

-   **仕様**：

    -   **4パターンのフレーズ**をランダムまたは文脈で選択：
        - 「ゆっくりでいいから、話したいことがあったら教えてね」
        - 「今日はのんびりでも大丈夫だよ」
        - 「無理しなくていいからね」
        - 「ぼちぼちでいこう」

    -   **使用条件**：初回セッション / today_form_summary が Poor・Critical推定時 / 児童の緊張・不安表示時

    -   **クールダウン機能**：直近 `${reassurance_cooldown_sessions}` セッション以内の同一フレーズ使用を回避

### **7. 会話効果学習・記録機能【新規推奨】**

-   **目的**：児童個別の対話品質向上。

-   **仕様**：

    -   **効果記録**：児童の反応が良かった話題・アプローチを `${child_id}` 単位で記録

    -   **回避記録**：避けた方が良い表現・タイミングを学習・蓄積

    -   **カスタマイズ蓄積**：個別特性に合わせた最適化パターンを段階的に構築

    -   **スタッフ連携**：重要な気づきや変化を人間スタッフ向けに記録・通知

### **8. 誤認修正・理解確認機能【新規】**

-   **目的**：子どもとの誤解を防ぎ、信頼関係を維持。

-   **仕様**：

    -   **トリガー検出**：「違う」「そうじゃない」「ちがうよ」等の否定表現、または曖昧・消極的な反応を検知

    -   **必須確認動作**：検出時、必ず理解確認・修正を実行
        - 「そうだった？もう一回教えて？」
        - 「ちゃんと聞けてなかったかも、教えて？」

    -   **エラー処理**：同じ質問繰り返し時は一行謝罪→即座に別角度切り替え

### **9. 段階的質問・褒め多様化システム【新規】**

-   **目的**：子どもの発話促進と自己効力感向上。

-   **仕様**：

    -   **段階的質問**：①Yes/No→②選択肢付き→③自由回答の順で難易度調整

    -   **褒め4パターン**：状況具体性・過去比較・第三者共有・プロセス重視をローテーション

    -   **相槌挿入**：「うんうん」「そうだね」を適切なタイミングで自動挿入

### **10. 緊急時・例外処理システム【新規】**

-   **目的**：AI対応限界時の安全確保。

-   **仕様**：

    -   **強い感情反応検知**：パニック・激しい怒り・深い悲しみのパターン認識→専用対応実行

    -   **不適切発言フィルター**：暴力的・攻撃的内容の検知→適切な誘導実行

    -   **人間スタッフ引き継ぎ判定**：専門的支援必要時の自動判定・通知機能

📌 **実装優先度**：

-   **高**：NGトピック柔軟化（1）、短文応答精緻化（2）、誤認修正（8）
-   **中**：無反応時再話しかけ（3）、質問・褒め多様化（9）、緊急時処理（10）  
-   **低**：会話効果学習（7）、その他の機能拡張

📌 **まとめ**：

-   プロンプトで記述した「人格・会話ルール」はそのまま利用

-   上記①〜⑩をシステム側の制御として追加実装

-   **v3.2.0対応により、技術的制御と人間らしい温かさを両立した実用的AIスタッフを実現**